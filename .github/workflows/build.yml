name: Build and Release

on:
  push:
    branches: [master, main]
    tags: ['v*']
  pull_request:
    branches: [master, main]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - os: ubuntu-latest
            name: linux-x64
            cmake_generator: Ninja
            arch: x64
            sanitizers: OFF
          # Linux x64 (Sanitizers)
          - os: ubuntu-latest
            name: linux-x64-sanitizers
            cmake_generator: Ninja
            arch: x64
            sanitizers: ON
          # Linux ARM64
          - os: ubuntu-24.04-arm
            name: linux-arm64
            cmake_generator: Ninja
            arch: arm64
            sanitizers: OFF
          # macOS x64 (Intel) - use macos-15-intel instead of deprecated macos-13
          - os: macos-15
            name: macos-x64
            cmake_generator: Ninja
            arch: x64
            sanitizers: OFF
          # macOS ARM64 (Apple Silicon)
          - os: macos-latest
            name: macos-arm64
            cmake_generator: Ninja
            arch: arm64
            sanitizers: OFF
          # Windows x64
          - os: windows-latest
            name: windows-x64
            cmake_generator: Ninja
            arch: x64
            sanitizers: OFF

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y flex bison ninja-build

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install flex bison ninja
          echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install winflexbison3 ninja -y
          echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure CMake
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            # Use Visual Studio generator on Windows for proper MSVC builds     
            cmake -B build -G "Visual Studio 17 2022" -A x64 -DMATIEC_BUILD_TESTS=ON
          else
            cmake -B build -G "${{ matrix.cmake_generator }}" -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DMATIEC_BUILD_TESTS=ON -DMATIEC_ENABLE_SANITIZERS=${{ matrix.sanitizers }}
          fi

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }}

      - name: Run tests
        shell: bash
        run: |
          cd build
          if [ "${{ matrix.sanitizers }}" = "ON" ]; then
            # Run with LeakSanitizer enabled as part of sanitizer guardrails.
            export ASAN_OPTIONS="detect_leaks=1:abort_on_error=1"
            export UBSAN_OPTIONS="print_stacktrace=1"
          fi
          ctest --output-on-failure -C ${{ env.BUILD_TYPE }}

      - name: Test executables
        if: matrix.sanitizers != 'ON'
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            ./build/Release/iec2c.exe -v || true
            ./build/Release/iec2iec.exe -v || true
          else
            ./build/iec2c -v || true
            ./build/iec2iec -v || true
          fi

      - name: Prepare distribution package
        if: matrix.sanitizers != 'ON'
        shell: bash
        run: |
          DIST_DIR="matiec-${{ matrix.name }}"
          mkdir -p "$DIST_DIR/bin"
          mkdir -p "$DIST_DIR/lib"

          # Copy executables
          if [ "$RUNNER_OS" == "Windows" ]; then
            cp build/Release/iec2c.exe "$DIST_DIR/bin/"
            cp build/Release/iec2iec.exe "$DIST_DIR/bin/"
          else
            cp build/iec2c "$DIST_DIR/bin/"
            cp build/iec2iec "$DIST_DIR/bin/"
          fi

          # Copy standard library
          cp -r src/lib/* "$DIST_DIR/lib/"

          # Copy documentation
          cp README.md "$DIST_DIR/"
          cp COPYING "$DIST_DIR/"

          # Create usage script (Unix)
          if [ "$RUNNER_OS" != "Windows" ]; then
            cat > "$DIST_DIR/iec2c.sh" << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          "$SCRIPT_DIR/bin/iec2c" -I "$SCRIPT_DIR/lib" "$@"
          EOF
            chmod +x "$DIST_DIR/iec2c.sh"
          fi

          # Create usage script (Windows)
          if [ "$RUNNER_OS" == "Windows" ]; then
            cat > "$DIST_DIR/iec2c.cmd" << 'EOF'
          @echo off
          "%~dp0bin\iec2c.exe" -I "%~dp0lib" %*
          EOF
          fi

      - name: Upload artifacts
        if: matrix.sanitizers != 'ON'
        uses: actions/upload-artifact@v4
        with:
          name: matiec-${{ matrix.name }}
          path: matiec-${{ matrix.name }}
          retention-days: 30

  build-consistency:
    runs-on: ubuntu-latest
    name: Build Consistency Gate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flex bison ninja-build

      - name: Validate build option combinations
        run: python3 tools/ci/check_build_consistency.py

  # Create NuGet package
  nuget:
    needs: [build, build-consistency]
    runs-on: windows-latest
    name: Package NuGet

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Prepare package structure
        shell: pwsh
        run: |
          # Create package directories
          New-Item -ItemType Directory -Force -Path "package/tools/win-x64"
          New-Item -ItemType Directory -Force -Path "package/tools/linux-x64"
          New-Item -ItemType Directory -Force -Path "package/tools/linux-arm64"
          New-Item -ItemType Directory -Force -Path "package/tools/osx-x64"
          New-Item -ItemType Directory -Force -Path "package/tools/osx-arm64"
          New-Item -ItemType Directory -Force -Path "package/lib"
          New-Item -ItemType Directory -Force -Path "package/build"
          New-Item -ItemType Directory -Force -Path "package/docs"

          # Copy binaries
          Copy-Item -Path "artifacts/matiec-windows-x64/bin/*" -Destination "package/tools/win-x64/"
          Copy-Item -Path "artifacts/matiec-linux-x64/bin/*" -Destination "package/tools/linux-x64/"
          Copy-Item -Path "artifacts/matiec-linux-arm64/bin/*" -Destination "package/tools/linux-arm64/"
          Copy-Item -Path "artifacts/matiec-macos-x64/bin/*" -Destination "package/tools/osx-x64/"
          Copy-Item -Path "artifacts/matiec-macos-arm64/bin/*" -Destination "package/tools/osx-arm64/"

          # Copy lib folder
          Copy-Item -Path "src/lib/*" -Destination "package/lib/" -Recurse

          # Copy MSBuild integration files (if they exist)
          if (Test-Path "build/matiec.props") {
            Copy-Item -Path "build/matiec.props" -Destination "package/build/"
          }
          if (Test-Path "build/matiec.targets") {
            Copy-Item -Path "build/matiec.targets" -Destination "package/build/"
          }

          # Copy documentation
          Copy-Item -Path "README.md" -Destination "package/docs/"

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $version = $matches[1]
          } else {
            $version = "0.3.0-preview.${{ github.run_number }}"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Create NuGet package
        shell: pwsh
        run: |
          nuget pack matiec.nuspec -Version ${{ steps.version.outputs.VERSION }} -BasePath package -OutputDirectory nupkg

      - name: Upload NuGet package
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: nupkg/*.nupkg
          retention-days: 30

  # Publish to NuGet.org on tag
  publish-nuget:
    needs: nuget
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    name: Publish NuGet

    steps:
      - name: Download NuGet package
        uses: actions/download-artifact@v4
        with:
          name: nuget-package
          path: .

      - name: Setup NuGet
        uses: nuget/setup-nuget@v2

      - name: Check NuGet API key
        id: nuget-key
        shell: pwsh
        run: |
          if ("${{ secrets.NUGET_API_KEY }}" -eq "") {
            "has_key=false" >> $env:GITHUB_OUTPUT
          } else {
            "has_key=true" >> $env:GITHUB_OUTPUT
          }

      - name: Skip publish (missing API key)
        if: steps.nuget-key.outputs.has_key != 'true'
        shell: pwsh
        run: |
          Write-Host "NUGET_API_KEY 未配置，跳过 NuGet 发布。"

      - name: Publish to NuGet.org
        if: steps.nuget-key.outputs.has_key == 'true'
        run: |
          nuget push nupkg/*.nupkg -Source https://api.nuget.org/v3/index.json -ApiKey ${{ secrets.NUGET_API_KEY }} -SkipDuplicate

  # Create GitHub Release on tag
  release:
    needs: [build, nuget]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    name: Create Release
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release archives
        run: |
          cd artifacts

          # Create archives for each platform
          for dir in matiec-*/; do
            name="${dir%/}"
            echo "Creating archive for $name..."

            # Create zip
            zip -r "../${name}.zip" "$dir"

            # Create tar.gz
            tar -czvf "../${name}.tar.gz" "$dir"
          done

          cd ..

          # List created archives
          echo "=== Created archives ==="
          ls -la *.zip *.tar.gz

      - name: Generate checksums
        run: |
          echo "# SHA256 Checksums" > checksums.txt
          echo "" >> checksums.txt
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> checksums.txt
          echo "Version: ${{ steps.version.outputs.VERSION }}" >> checksums.txt
          echo "" >> checksums.txt

          for file in *.zip *.tar.gz; do
            sha256sum "$file" >> checksums.txt
          done

          # Also add NuGet package checksum
          if [ -f "artifacts/nuget-package/"*.nupkg ]; then
            sha256sum artifacts/nuget-package/*.nupkg >> checksums.txt
          fi

          echo ""
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: matiec v${{ steps.version.outputs.VERSION }}
          body: |
            ## matiec v${{ steps.version.outputs.VERSION }}

            IEC 61131-3 compiler - converts PLC code (ST/IL/SFC) to ANSI C.

            ### Downloads

            | Platform | Architecture | Archive |
            |----------|--------------|---------|
            | Windows | x64 | `matiec-windows-x64.zip` |
            | Linux | x64 | `matiec-linux-x64.tar.gz` |
            | Linux | ARM64 | `matiec-linux-arm64.tar.gz` |
            | macOS | x64 (Intel) | `matiec-macos-x64.tar.gz` |
            | macOS | ARM64 (Apple Silicon) | `matiec-macos-arm64.tar.gz` |
            | NuGet | All platforms | `matiec.${{ steps.version.outputs.VERSION }}.nupkg` |

            ### Quick Start

            ```bash
            # Extract and run
            tar -xzf matiec-linux-x64.tar.gz
            cd matiec-linux-x64
            ./bin/iec2c -I lib -T output/ your_program.st

            # Or use the convenience script
            ./iec2c.sh -T output/ your_program.st
            ```

            ### Package Contents

            Each archive contains:
            - `bin/` - Executables (iec2c, iec2iec)
            - `lib/` - IEC 61131-3 standard library
            - `README.md` - Documentation
            - `COPYING` - License (GPL-3.0)

            ### Installation via Package Managers

            **NuGet:**
            ```
            nuget install matiec
            ```

            **CPM.cmake:**
            ```cmake
            CPMAddPackage("gh:lusipad/matiec-cmake@v${{ steps.version.outputs.VERSION }}")
            ```

            See [INTEGRATION.md](https://github.com/lusipad/matiec-cmake/blob/master/docs/INTEGRATION.md) for more options.

            ---

            **Full Changelog**: https://github.com/lusipad/matiec-cmake/compare/...v${{ steps.version.outputs.VERSION }}
          files: |
            *.zip
            *.tar.gz
            checksums.txt
            artifacts/nuget-package/*.nupkg
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-alpha') || contains(github.ref, '-beta') || contains(github.ref, '-rc') }}
