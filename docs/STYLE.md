# 代码风格与 Modern C++ 基线

本仓库包含较多历史代码（2000s 风格，宏/裸指针较多）。本文件的目的不是要求一次性
“全库现代化”，而是提供一个可执行的基线：让新代码/触及到的代码逐步变得一致、可维护、
可测试，并且不引入大规模纯格式化 diff。

## 总原则

- 正确性优先：任何“风格改造”不得改变编译语义与输出（除非明确记录并有测试覆盖）。
- 小步可回滚：一次 PR/提交尽量聚焦一个点，避免大范围机械替换。
- 可验证：改动必须可通过构建与测试验证（见 `docs/testing-policy.md`）。

## 格式化与编辑器配置

- `.clang-format`：提供 clang-format 的默认风格基线。
  - 仅用于“新代码或被修改的文件/片段”。
  - 不要在没有专项计划的情况下对全仓库一键格式化。
- `.editorconfig`：提供行尾/缩进/字符集的编辑器基线（默认 UTF-8 + LF）。

## C++17 基线（新代码）

- 使用 C++17（见顶层 `CMakeLists.txt`）。
- 优先使用 `nullptr`、`std::unique_ptr`、`std::string` / `std::string_view`。
- 尽量避免隐式所有权、裸 `new/delete`、手工 `malloc/free`（除非在 C API 边界）。

## 所有权与资源管理（RAII）

- “谁释放，谁拥有”：拥有关系必须明确。
  - 拥有：`std::unique_ptr<T>` / 值语义对象。
  - 非拥有：原始指针/引用可以使用，但需要在命名或注释中明确其生命周期来源。
- 对资源（文件句柄、临时文件/目录、Windows HANDLE 等）使用 RAII 封装：
  - `std::unique_ptr<T, Deleter>` / 轻量 guard 类型。

## 错误处理

- 新代码优先使用 `matiec::globalErrorReporter()` 收集错误并向上返回错误码/异常。
- 避免在库路径中 `exit()`；命令行工具可以在最外层统一转换为返回码。
- 历史宏 `ERROR/ERROR_MSG` 仅用于兼容；新代码不要新增依赖。

## 字符串与缓冲区

- 优先使用 `std::string` / `std::string_view`，避免固定长度缓冲区与不安全的 C 字符串 API。
- 需要拼接路径/文件名时，优先使用 `std::filesystem::path`（测试与工具代码中已使用）。

## 提交/评审建议（最小清单）

- 改动范围是否可回滚、是否只有必要的重排/格式化？
- 所有权是否清晰？是否减少了裸指针/手工释放？
- 是否补了测试或强化了现有断言？
- 是否按 `docs/testing-policy.md` 跑了构建与测试，并在描述中如实记录？

